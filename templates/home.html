<html>
  <head>
    <title>Hello from Flask</title>
    <meta content="text/html; charset = UTF-8" http-equiv="content-type">
      	
    <script type = "application/javascript">
       function loadJSON(data_file, callback){
          var http_request = new XMLHttpRequest();
          try{
             // Opera 8.0+, Firefox, Chrome, Safari
             http_request = new XMLHttpRequest();
          }catch (e){
             // Internet Explorer Browsers
             try{
                http_request = new ActiveXObject("Msxml2.XMLHTTP");
      				
             }catch (e) {
      			
                try{
                   http_request = new ActiveXObject("Microsoft.XMLHTTP");
                }catch (e){
                   // Something went wrong
                   alert("Your browser broke!");
                   return false;
                }
      				
             }
          }
      		
          http_request.onreadystatechange = function(){
      		
             if (http_request.readyState == 4  ){
                // Javascript function JSON.parse to parse JSON data
                var jsonObj = JSON.parse(http_request.responseText);
                callback(jsonObj);
             }
          }
      		
          http_request.open("GET", data_file, true);
          http_request.send();
       }
    </script>
    <style>
      .plate {width: 100%; display: block;}
      .relay {width: 14%; display: inline-block;}
      .relay_on {background-color: green;}
      .relay_off {background-color: red;}
    </style>
  </head>
  <body id=body>
  <script>
    var baseRelayObj = "<div id=baseid onclick=\"javascript:change_relay_state(\'baseurl/toggle\', \'baseid\')\">basestate</div>";
    function relay_inserter(baseObj, url, state) {
      var splits = url.split('/');
      var plate_num = splits[splits.length-2];
      var relay_num = splits[splits.length-1];
      var plate_id = "plate_" + plate_num;
      var my_id = "plate_" + plate_num + "_relay_" + relay_num;
      baseObj = baseObj.replace(/baseid/g, my_id); 
      baseObj = baseObj.replace(/baseurl/g, url);
      baseObj = baseObj.replace(/basestate/g, state);
      var plate_obj = document.getElementById(plate_id);
      if(plate_obj == null) {
        document.getElementById("plates").innerHTML = document.getElementById("plates").innerHTML + "<div id=" + plate_id + " class=\"plate\"><span class=\"plate\">" + plate_id + "</span></div>";
      }
      var obj = document.getElementById(my_id);
      if(obj == null){
        document.getElementById(plate_id).innerHTML = document.getElementById(plate_id).innerHTML + baseObj;
      } else {
        obj.parentNode.replaceChild(baseObj, obj);
      }
      document.getElementById(my_id).className = "relay relay_" + state;
    }
    function data_inserter(url, data, id){
      var bodyObj = document.getElementById(id);
      bodyObj.innerHTML = bodyObj.innerHTML + "url: " + url + ", state: " + data + "<br />";
    }
    function change_relay_state(url, my_id) {
      loadJSON(url, function(jsonObj){
        document.getElementById(my_id).className = "relay relay_" + jsonObj["state"];
        document.getElementById(my_id).textContent = jsonObj["state"];
      });
    }

    loadJSON('/api/v1/plate', function(jsonObj){
      for(var key in jsonObj) {
        loadJSON(key, function(myobj) {
          for(new_key in myobj) {
            relay_inserter(baseRelayObj, new_key, myobj[new_key]);
          }
        });
      }
    });
  </script>
  <div id="plates"></div>
  </body>
</html>
